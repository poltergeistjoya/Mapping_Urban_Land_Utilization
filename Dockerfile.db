FROM postgis/postgis:15-3.3

# Install pgRouting
RUN apt-get update && \
    apt-get install -y postgresql-15-pgrouting && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists*

# Allow connections from any IP address (for development only)
RUN echo "listen_addresses='*'" >> /usr/share/postgresql/postgresql.conf.sample

# Copy the dump file to a temporary location
COPY recent_dump.sql /tmp/recent_dump.sql

# Create a startup script
RUN echo '#!/bin/bash\n\
# Start PostgreSQL in the background\n\
docker-entrypoint.sh postgres &\n\
\n\
# Wait for PostgreSQL to be ready\n\
until pg_isready -U postgres; do\n\
  echo "Waiting for postgres..."\n\
  sleep 2\n\
done\n\
\n\
# Load the dump file\n\
psql -U postgres -d urban_utilization -f /tmp/recent_dump.sql\n\
\n\
# Keep container running\n\
wait' > /docker-entrypoint-initdb.d/start.sh

# Make the script executable
RUN chmod +x /docker-entrypoint-initdb.d/start.sh
